<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dark Checker</title>
    <script src="https://js.stripe.com/v3/"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: #0d1117;
            min-height: 100vh;
            padding: 30px 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #c9d1d9;
        }

        .container {
            max-width: 580px;
            width: 100%;
            background: #161b22;
            padding: 32px;
            border-radius: 12px;
            border: 1px solid #30363d;
        }

        .header {
            text-align: center;
            margin-bottom: 24px;
        }

        .logo {
            width: 48px;
            height: 48px;
            margin: 0 auto 16px;
            background: linear-gradient(135deg, #f59e0b, #d97706);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 26px;
        }

        h1 {
            font-size: 24px;
            font-weight: 600;
            color: #f0f6fc;
            margin-bottom: 4px;
        }

        .subtitle {
            color: #8b949e;
            font-size: 14px;
        }

        .user-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: #0d1117;
            border-radius: 6px;
            border: 1px solid #21262d;
            margin-bottom: 20px;
            font-size: 13px;
        }

        .checks-remaining {
            font-weight: 600;
            color: #f59e0b;
        }

        .beta-badge {
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid rgba(245, 158, 11, 0.2);
            color: #f59e0b;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .logout-btn {
            background: #21262d;
            color: #f85149;
            border: 1px solid #f85149;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .logout-btn:hover {
            background: #f85149;
            color: #fff;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            background: rgba(46, 160, 67, 0.1);
            border-radius: 6px;
            margin-bottom: 16px;
            font-size: 13px;
            border: 1px solid rgba(46, 160, 67, 0.2);
        }

        .status-dot {
            width: 6px;
            height: 6px;
            background: #3fb950;
            border-radius: 50%;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            color: #f0f6fc;
            font-weight: 500;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .form-group select,
        .form-group input {
            width: 100%;
            padding: 10px 12px;
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 6px;
            font-size: 14px;
            color: #f0f6fc;
            transition: all 0.15s;
            outline: none;
        }

        .form-group select {
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23f59e0b' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            padding-right: 36px;
            background-color: #0d1117;
        }

        .form-group input::placeholder {
            color: #8b949e;
        }

        .form-group select:hover,
        .form-group input:hover {
            border-color: #484f58;
        }

        .form-group select:focus,
        .form-group input:focus {
            border-color: #f59e0b;
            background: #0d1117;
        }

        .card-input-row {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
        }

        .card-input-col {
            flex: 1;
        }

        .card-input-col-small {
            flex: 0 0 80px;
        }

        .card-fields-note {
            color: #8b949e;
            font-size: 11px;
            margin-top: 6px;
        }

        .error-message {
            background: rgba(248, 81, 73, 0.1);
            border: 1px solid rgba(248, 81, 73, 0.3);
            color: #ff7b72;
            padding: 10px 12px;
            border-radius: 6px;
            margin-bottom: 12px;
            font-size: 13px;
            display: none;
        }

        #verify-button {
            width: 100%;
            padding: 12px 20px;
            background: linear-gradient(180deg, #f59e0b, #d97706);
            color: #000;
            border: 1px solid #b45309;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s;
            margin-top: 8px;
        }

        #verify-button:hover:not(:disabled) {
            background: linear-gradient(180deg, #fbbf24, #f59e0b);
        }

        #verify-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 24px;
            margin-top: 16px;
            background: #0d1117;
            border-radius: 6px;
            border: 1px solid #21262d;
        }

        .spinner {
            border: 3px solid #21262d;
            border-radius: 50%;
            border-top: 3px solid #f59e0b;
            width: 32px;
            height: 32px;
            animation: spin 0.7s linear infinite;
            margin: 0 auto 12px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading p {
            color: #8b949e;
            font-size: 14px;
        }

        .results {
            display: none;
            margin-top: 16px;
        }

        .results h3 {
            color: #f0f6fc;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .result-item {
            padding: 16px;
            border-radius: 6px;
            font-size: 14px;
            line-height: 1.5;
        }

        .result-approved {
            background: rgba(46, 160, 67, 0.15);
            border: 1px solid rgba(46, 160, 67, 0.4);
            color: #7ee787;
        }

        .result-declined {
            background: rgba(187, 128, 9, 0.15);
            border: 1px solid rgba(187, 128, 9, 0.4);
            color: #f0b429;
        }

        .result-error {
            background: rgba(248, 81, 73, 0.15);
            border: 1px solid rgba(248, 81, 73, 0.4);
            color: #ff7b72;
        }

        @media (max-width: 640px) {
            .card-input-row {
                flex-direction: column;
            }
            .card-input-col-small {
                flex: 1;
            }
            .user-info {
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }
        }

        #maintenance-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(1, 4, 9, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 12px;
            padding: 32px;
            max-width: 400px;
            width: 90%;
            text-align: center;
        }

        .modal-content h2 {
            color: #f0f6fc;
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .modal-content p {
            color: #8b949e;
            font-size: 14px;
            line-height: 1.5;
            margin-bottom: 10px;
        }

        .modal-content .icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .modal-btn {
            width: 100%;
            padding: 10px 18px;
            background: linear-gradient(180deg, #f59e0b, #d97706);
            color: #000;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            margin-top: 16px;
        }

        .modal-btn:hover {
            background: linear-gradient(180deg, #fbbf24, #f59e0b);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">üåô</div>
            <h1>Dark Checker</h1>
            <p class="subtitle">Card Verification System</p>
        </div>
        
        <div class="user-info">
            <div>
                <span class="checks-remaining">Checks: <strong id="checks-remaining">--</strong></span>
            </div>
            <span class="beta-badge">BETA</span>
            <button class="logout-btn" onclick="window.location.href='/checker/logout'">Logout</button>
        </div>

        <div class="status-indicator">
            <div class="status-dot"></div>
            <div>Estado: <span id="stripe-status">Cargando...</span></div>
        </div>

        <div class="form-group">
            <label for="gate-selector">üéØ Selecciona el Gate</label>
            <select id="gate-selector">
                <option value="">-- Selecciona un gate --</option>
            </select>
            <div id="gate-selector-error" class="error-message"></div>
        </div>

        <div id="card-fields-container" style="display: none;">
            <div id="braintree-card-fields">
                <div class="form-group">
                    <label for="card-number-full">üí≥ N√∫mero de Tarjeta</label>
                    <input 
                        type="text" 
                        id="card-number-full" 
                        placeholder="4242 4242 4242 4242"
                        maxlength="19"
                        autocomplete="cc-number"
                    >
                </div>
                <div class="card-input-row">
                    <div class="card-input-col">
                        <label for="card-exp-month">Mes</label>
                        <input 
                            type="text" 
                            id="card-exp-month" 
                            placeholder="12"
                            maxlength="2"
                        >
                    </div>
                    <div class="card-input-col">
                        <label for="card-exp-year">A√±o</label>
                        <input 
                            type="text" 
                            id="card-exp-year" 
                            placeholder="25"
                            maxlength="2"
                        >
                    </div>
                    <div class="card-input-col-small">
                        <label for="card-cvv-full">CVV</label>
                        <input 
                            type="text" 
                            id="card-cvv-full" 
                            placeholder="123"
                            maxlength="4"
                        >
                    </div>
                </div>
                <small class="card-fields-note">üîí Campos directos</small>
            </div>
        </div>
        
        <button id="verify-button" onclick="verifySelectedGate()">
            üîç Verificar Tarjeta
        </button>
        
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Verificando tarjeta...</p>
        </div>
        
        <div class="results" id="results">
            <h3>Resultado</h3>
            <div id="result-content"></div>
        </div>
    </div>

    <div id="maintenance-modal">
        <div class="modal-content">
            <div class="icon">‚ö†Ô∏è</div>
            <h2>Gate en mantenimiento</h2>
            <p>El gate <strong>Charged</strong> est√° temporalmente desactivado.</p>
            <p>Por favor, usa otro gate.</p>
            <button onclick="closeMaintenanceModal()" class="modal-btn">Entendido</button>
        </div>
    </div>

    <script>
        let stripe = null;
        let verifyStartTime = null;
        let checksRemaining = 0;

        function showMaintenanceModal() {
            document.getElementById('maintenance-modal').style.display = 'flex';
        }

        function closeMaintenanceModal() {
            document.getElementById('maintenance-modal').style.display = 'none';
        }

        document.addEventListener('DOMContentLoaded', function() {
            const modal = document.getElementById('maintenance-modal');
            modal.addEventListener('click', function(e) {
                if (e.target === modal) closeMaintenanceModal();
            });
        });

        async function loadStripeConfig() {
            try {
                const response = await fetch('/checker/get_config');
                if (!response.ok) throw new Error('Error al obtener configuraci√≥n');
                
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    document.getElementById('stripe-status').textContent = 'Error de servidor';
                    return;
                }
                
                const data = await response.json();
                
                if (data.success) {
                    checksRemaining = data.checks_remaining || 0;
                    document.getElementById('checks-remaining').textContent = checksRemaining;
                    document.getElementById('stripe-status').textContent = '‚úÖ Activo';
                    
                    const gates = data.gates || {};
                    renderGates(gates);
                    window.gatesConfig = gates;
                    
                    if (data.stripe_pk) {
                        initializeStripe(data.stripe_pk);
                    }
                } else {
                    document.getElementById('stripe-status').textContent = 'Sin configuraci√≥n';
                }
            } catch (error) {
                document.getElementById('stripe-status').textContent = 'Error de conexi√≥n';
            }
        }

        function initializeStripe(pkKey) {
            if (!pkKey) return true;
            try {
                stripe = Stripe(pkKey);
                return true;
            } catch (error) {
                return true;
            }
        }

        function toggleCardFields(selectedGate) {
            const container = document.getElementById('card-fields-container');
            if (!container) return;
            
            if (!selectedGate || selectedGate === '') {
                container.style.display = 'none';
            } else {
                container.style.display = 'block';
            }
        }
        
        function renderGates(gates) {
            const selector = document.getElementById('gate-selector');
            const errorDiv = document.getElementById('gate-selector-error');
            
            while (selector.children.length > 1) {
                selector.removeChild(selector.lastChild);
            }
            
            let enabledGatesCount = 0;
            
            for (const [gateId, gateConfig] of Object.entries(gates)) {
                if (!gateConfig || typeof gateConfig !== 'object') continue;
                
                const enabled = gateConfig.enabled !== false;
                const icon = gateConfig.icon || 'üîê';
                const name = gateConfig.name || gateId;
                const description = gateConfig.description || '';
                
                const option = document.createElement('option');
                option.value = gateId;
                option.textContent = `${icon} ${name}${description ? ` - ${description}` : ''}`;
                option.disabled = !enabled;
                
                if (!enabled) {
                    option.textContent += ' (Mantenimiento)';
                } else {
                    enabledGatesCount++;
                }
                
                selector.appendChild(option);
            }
            
            if (enabledGatesCount === 0) {
                errorDiv.textContent = '‚ö†Ô∏è No hay gates disponibles';
                errorDiv.style.display = 'block';
                selector.disabled = true;
            } else {
                errorDiv.style.display = 'none';
                selector.disabled = false;
            }
            
            if (!selector.hasAttribute('data-listener-added')) {
                selector.addEventListener('change', function(e) {
                    toggleCardFields(e.target.value);
                });
                selector.setAttribute('data-listener-added', 'true');
            }
            
            toggleCardFields(selector.value);
        }
        
        function verifySelectedGate() {
            const selector = document.getElementById('gate-selector');
            const selectedGate = selector.value;
            
            if (!selectedGate) {
                const errorDiv = document.getElementById('gate-selector-error');
                errorDiv.textContent = '‚ö†Ô∏è Selecciona un gate';
                errorDiv.style.display = 'block';
                return;
            }
            
            verifyCard(selectedGate);
        }

        async function verifyCard(mode = 'auth') {
            const gatesConfig = window.gatesConfig || {};
            const gateConfig = gatesConfig[mode];
            
            if (!gateConfig || !gateConfig.enabled) {
                if (mode === 'charge') {
                    showMaintenanceModal();
                } else {
                    showResult('error', `‚ö†Ô∏è Gate ${gateConfig?.name || mode} en mantenimiento`, {});
                }
                return;
            }

            if (checksRemaining <= 0) {
                showResult('error', '‚ùå L√≠mite de checks alcanzado', {});
                return;
            }

            const selector = document.getElementById('gate-selector');
            const verifyButton = document.getElementById('verify-button');
            selector.disabled = true;
            verifyButton.disabled = true;
            
            const loading = document.getElementById('loading');
            const results = document.getElementById('results');
            
            loading.style.display = 'block';
            results.style.display = 'none';
            verifyStartTime = Date.now();

            try {
                const cardNumberFull = document.getElementById('card-number-full')?.value.trim().replace(/\s+/g, '').replace(/-/g, '') || '';
                const expMonth = document.getElementById('card-exp-month')?.value.trim() || '';
                const expYear = document.getElementById('card-exp-year')?.value.trim() || '';
                const cvvFull = document.getElementById('card-cvv-full')?.value.trim() || '';
                
                if (!cardNumberFull || cardNumberFull.length < 13) {
                    showResult('error', '‚ùå Ingresa el n√∫mero de tarjeta', {});
                    return;
                }
                
                if (!expMonth || !expYear) {
                    showResult('error', '‚ùå Ingresa la fecha de expiraci√≥n', {});
                    return;
                }
                
                if (!cvvFull) {
                    showResult('error', '‚ùå Ingresa el CVV', {});
                    return;
                }
                
                let endpoint = '/checker/verify_auth';
                if (mode === 'charge') endpoint = '/checker/verify_charge';
                else if (mode === 'stripe_auth') endpoint = '/checker/verify_stripe_auth';
                else if (mode === 'braintree') endpoint = '/checker/verify_braintree';
                
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        card_number: cardNumberFull,
                        exp_month: expMonth,
                        exp_year: expYear,
                        cvv: cvvFull
                    })
                });

                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    let errorMsg = '‚ùå Error del servidor';
                    if (response.status === 429) errorMsg = '‚ùå Demasiadas solicitudes';
                    else if (response.status === 401 || response.status === 403) errorMsg = '‚ùå Error de autenticaci√≥n';
                    else if (response.status >= 500) errorMsg = '‚ùå Gateway no disponible';
                    showResult('error', errorMsg, {});
                    return;
                }
                
                const data = await response.json();
                const verifyTime = ((Date.now() - verifyStartTime) / 1000).toFixed(2);

                if (data && data.success) {
                    checksRemaining = data.checks_remaining || 0;
                    document.getElementById('checks-remaining').textContent = checksRemaining;
                    
                    const binInfo = data.details?.bin_info || null;
                    showResult('approved', data.message, data.details || {}, verifyTime, binInfo);
                } else {
                    if (data.checks_remaining !== undefined) {
                        checksRemaining = data.checks_remaining;
                        document.getElementById('checks-remaining').textContent = checksRemaining;
                    }
                    
                    let errorMsg = data.error || data.message || 'Error al verificar';
                    if (!errorMsg.startsWith('‚ùå')) errorMsg = '‚ùå ' + errorMsg;
                    
                    showResult(data.status === 'declined' ? 'declined' : 'error', errorMsg, data.details || {});
                }

            } catch (error) {
                showResult('error', '‚ùå Error de conexi√≥n', {});
            } finally {
                selector.disabled = false;
                verifyButton.disabled = false;
                loading.style.display = 'none';
            }
        }

        function getCountryEmoji(code) {
            if (!code) return 'üåç';
            const emojis = {
                'US': 'üá∫üá∏', 'CA': 'üá®üá¶', 'GB': 'üá¨üáß', 'MX': 'üá≤üáΩ', 'BR': 'üáßüá∑'
            };
            return emojis[code.toUpperCase()] || 'üåç';
        }

        function getCountryName(code) {
            if (!code) return 'Desconocido';
            const countries = {
                'US': 'Estados Unidos', 'CA': 'Canad√°', 'GB': 'Reino Unido', 'MX': 'M√©xico', 'BR': 'Brasil'
            };
            return countries[code.toUpperCase()] || code;
        }

        function showResult(type, message, details, verifyTime = '0.00', binInfo = null) {
            const results = document.getElementById('results');
            const resultContent = document.getElementById('result-content');
            
            const className = type === 'approved' ? 'result-approved' : 
                            type === 'declined' ? 'result-declined' : 'result-error';
            
            let detailsHtml = '';
            
            if (type === 'approved' && details.card) {
                const card = details.card;
                const brand = (card.brand || 'Unknown').toUpperCase();
                const last4 = card.last4 || '****';
                const country = card.country || 'N/A';
                
                let countryName = getCountryName(country);
                let countryEmoji = getCountryEmoji(country);
                
                if (binInfo && binInfo.country) {
                    if (typeof binInfo.country === 'object') {
                        countryName = binInfo.country.name || countryName;
                        countryEmoji = binInfo.country.emoji || countryEmoji;
                    }
                }
                
                detailsHtml += `
                    <div style="margin-top: 12px; padding: 14px; background: rgba(46, 160, 67, 0.1); border-radius: 6px; border: 1px solid rgba(46, 160, 67, 0.3);">
                        <div style="font-size: 14px; font-weight: 600; margin-bottom: 12px; text-align: center;">
                            ‚úÖ VERIFICADA
                        </div>
                        <div style="font-size: 13px;">
                            <div style="margin-bottom: 6px;">
                                <strong>√öltimos 4:</strong> ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ${last4}
                            </div>
                            <div style="margin-bottom: 6px;">
                                <strong>Tipo:</strong> ${brand}
                            </div>
                            <div style="margin-bottom: 6px;">
                                <strong>Pa√≠s:</strong> ${countryName} ${countryEmoji}
                            </div>
                            <div>
                                <strong>Tiempo:</strong> ${verifyTime}s
                            </div>
                        </div>
                    </div>
                `;
            }
            
            resultContent.innerHTML = `<div class="result-item ${className}">${message}${detailsHtml}</div>`;
            results.style.display = 'block';
        }
        
        loadStripeConfig();
    </script>
</body>
</html>
